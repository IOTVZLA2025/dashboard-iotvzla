
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MONITOREO IOTVZLA</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png">

<style>
  :root{
    --bg:#071427;
    --card:#0b1220;
    --accent:#00bcd4;
    --muted:#9fb3c8;
    --yellow:#ffca28;
    --orange:#ff9800;
    --danger:#ff1744;
    --ok:#00c853;
  }

  body{
    margin:0;
    background:#071427;
    font-family:Arial;
    color:white;
  }

  .container{
    max-width:900px;
    margin:auto;
    padding:10px;
  }

  /* ==================== GAUGE ==================== */

  .gauge-box{
    background:var(--card);
    padding:10px;
    border-radius:10px;
    margin-bottom:15px;
    text-align:center;
  }

  .gauge-area{
    position:relative;
    width:330px;
    height:180px;
    margin:auto;
  }

  .gauge-bg{
    width:330px;
    height:165px;
    background:#0d1a2b;
    border-radius:0 0 200px 200px;
    border:5px solid rgba(255,255,255,0.1);
    border-top:none;
    position:absolute;
    left:0;
    top:15px;
    overflow:hidden;
  }

  .gauge-arc{
    position:absolute;
    width:330px;
    height:165px;
    top:15px;
    left:0;
    border-radius:0 0 200px 200px;
    background:conic-gradient(
      from 180deg,
      #00c853 0deg,
      #ffca28 90deg,
      #ff9800 135deg,
      #ff1744 180deg
    );
    opacity:0.35;
  }

  /* Aguja */
  .needle{
    --rot:180deg;
    position:absolute;
    width:3px;
    height:110px;
    background:#ffca28;
    top:15px;
    left:calc(50% - 1.5px);
    transform-origin:50% 150px;
    transform:rotate(var(--rot));
    box-shadow:0 0 8px #ffca28;
  }

  .needle-center{
    width:16px;
    height:16px;
    background:black;
    border:3px solid #ffca28;
    border-radius:50%;
    position:absolute;
    top:160px;
    left:calc(50% - 8px);
  }

  /* Números y marcas */
  .tick{
    position:absolute;
    width:2px;
    height:12px;
    background:white;
    top:15px;
    left:calc(50% - 1px);
    transform-origin:50% 150px;
    opacity:0.8;
  }
  .tick-minor{
    height:6px;
    opacity:0.5;
  }

  .gauge-number{
    position:absolute;
    color:white;
    font-size:12px;
    font-weight:700;
    transform:translate(-50%, -50%);
  }

  .temp-digital{
    font-size:45px;
    font-weight:bold;
    margin-top:20px;
    text-shadow:0 0 15px #ffca28;
  }

</style>
</head>

<body>
<div class="container">

<div class="gauge-box">
  <div class="gauge-area">

    <div class="gauge-bg"></div>
    <div class="gauge-arc"></div>

    <!-- Contenedores para ticks y números -->
    <div id="ticks"></div>
    <div id="numbers"></div>

    <div id="needle" class="needle"></div>
    <div class="needle-center"></div>

  </div>

  <div class="temp-digital">
    <span id="temp-value">0.0</span>°C
  </div>

  <div id="last-update" style="margin-top:5px;color:var(--muted);font-size:13px;">
    Última actualización: ---
  </div>
</div>
<!-- PANEL DERECHO -->
<div class="card" style="padding:15px;border-radius:10px;background:var(--card);margin-bottom:10px;">
  <h3 style="margin:0 0 5px 0;">Estado de alarma</h3>
  <div id="alarma-text">---</div>
</div>

<div class="card" style="padding:15px;border-radius:10px;background:var(--card);margin-bottom:10px;">
  <h3 style="margin:0 0 5px 0;">Reset sistema</h3>
  <div id="reset-text">---</div>
</div>

<footer style="text-align:center;margin-top:20px;color:var(--muted);font-size:12px;">
  © 2025 IOTVZLA — Sistema IoT
</footer>
<script>
// CONFIGURACIÓN
const CONFIG = {
  channel: "3194050",
  apiKey: "4L6L63LNFO0YG4BB",
  field: 1,
  minTemp: -15,
  maxTemp: 100,
  interval: 30000
};

/* ================================
   CREAR TICKS Y NÚMEROS (CORREGIDO)
   ================================ */
function initGauge() {
  const ticks = document.getElementById("ticks");
  const numbers = document.getElementById("numbers");

  const min = CONFIG.minTemp;
  const max = CONFIG.maxTemp;
  const total = max - min;

  for (let t = min; t <= max; t += 5) {
    const percent = (t - min) / total;
    const angle = 180 - percent * 180;  // 180° → 0°

    // Tick
    const tick = document.createElement("div");
    tick.className = "tick " + (t % 10 === 0 ? "" : "tick-minor");
    tick.style.transform = `rotate(${angle}deg)`;
    ticks.appendChild(tick);

    // Número cada 5°C
    const rad = angle * (Math.PI / 180);
    const r = 135;  // radio perfecto
    const x = 165 + Math.cos(rad) * r;
    const y = 165 - Math.sin(rad) * r;

    const num = document.createElement("div");
    num.className = "gauge-number";
    num.style.left = x + "px";
    num.style.top = y + "px";
    num.textContent = t;
    numbers.appendChild(num);
  }
}

/* ================================
   AGUJAS + COLOR DIGITAL
   ================================ */
function updateGauge(temp) {
  const needle = document.getElementById("needle");
  const digital = document.getElementById("temp-value");

  digital.textContent = temp.toFixed(1);

  const min = CONFIG.minTemp;
  const max = CONFIG.maxTemp;

  const p = (temp - min) / (max - min);
  const angle = 180 - p * 180;

  needle.style.setProperty("--rot", angle + "deg");

  digital.style.color =
    temp < 0 ? "#00bcd4" :
    temp <= 30 ? "#00c853" :
    temp <= 50 ? "#ffca28" :
    temp <= 60 ? "#ff9800" :
    "#ff1744";
}

/* ================================
   THINGSPEAK
   ================================ */
async function readTS() {
  const url =
    `https://api.thingspeak.com/channels/${CONFIG.channel}/fields/${CONFIG.field}/last.json?api_key=${CONFIG.apiKey}`;

  try {
    const r = await fetch(url);
    const j = await r.json();
    return parseFloat(j[`field${CONFIG.field}`]);
  } catch (e) {
    return null;
  }
}

async function updateAll() {
  const temp = await readTS();
  if (temp === null) return;

  updateGauge(temp);

  const d = new Date();
  document.getElementById("last-update").textContent =
    "Última actualización: " + d.toLocaleString("es-CL");
}

initGauge();
updateAll();
setInterval(updateAll, CONFIG.interval);
</script>
</body>
</html>

