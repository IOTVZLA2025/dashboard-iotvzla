<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MONITOREO VARIABLES MILLARES</title>
<link rel="icon" href="logo-millares.png" type="image/png">
<link rel="apple-touch-icon" href="logo-millares.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1622" />

<style>
  :root{
    --bg:#071427;
    --card:#0b1220;
    --accent:#00bcd4;
    --muted:#9fb3c8;
    --yellow:#ffca28;
    --orange:#ff9800;
    --danger:#ff1744;
    --ok:#00c853;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,Arial,Helvetica,sans-serif;
    background:linear-gradient(180deg,#020612 0%, #071427 100%);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
  }
  header{
    padding:14px 18px;
    border-bottom:1px solid rgba(255,255,255,0.04);
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
  }
  .logo-container {
    display:flex;
    align-items:center;
    gap:12px;
    flex:1;
    min-width:250px;
  }
  .logo-img {
    width:44px;
    height:44px;
    border-radius:10px;
    object-fit:contain;
    background:rgba(255,255,255,0.05);
    padding:4px;
  }
  .header-text {
    flex:1;
    min-width:200px;
  }
  .header-text h1{
    margin:0;
    font-size:18px;
    letter-spacing:0.6px;
    color:#fff;
  }
  .header-text .subtitle{
    font-size:12px;
    color:var(--muted);
    margin-top:2px;
  }
  .header-text .company-name{
    font-size:14px;
    color:#00bcd4;
    font-weight:600;
    margin-top:2px;
  }
  .container{max-width:980px;margin:18px auto;padding:12px;}
  .card{
    background:var(--card);
    border-radius:12px;
    padding:14px;
    border:1px solid rgba(255,255,255,0.03);
    box-shadow:0 10px 30px rgba(2,6,23,0.6);
    margin-bottom:12px
  }
  .main-grid{
    display:grid;
    grid-template-columns:1fr 360px;
    gap:14px
  }
  @media(max-width:820px){
    .main-grid{
      grid-template-columns:1fr;
    }
    .gauge{
      width:280px !important;
      height:280px !important;
    }
    .temp-value{
      font-size:48px !important;
    }
    header{
      padding:12px 14px;
    }
    .logo-container{
      min-width:100%;
      justify-content:center;
      text-align:center;
      margin-bottom:8px;
    }
    .header-text{
      text-align:center;
    }
  }
  @media(max-width:480px){
    .gauge{
      width:240px !important;
      height:240px !important;
    }
    .temp-value{
      font-size:42px !important;
    }
    .container{
      padding:8px;
    }
  }

  /* Gauge area */
  .gauge-wrap{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    padding:18px
  }
  .gauge-card{
    width:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:8px
  }
  .gauge{
    width:320px;
    height:320px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    /* solo franja exterior de color */
    background:
      radial-gradient(circle at center, #0b1220 70%, transparent 70%),
      conic-gradient(
        #03202b 0deg,
        #03202b 40deg,
        #003f5c 40deg,
        #003f5c 120deg,
        var(--yellow) 120deg,
        var(--yellow) 180deg,
        var(--orange) 180deg,
        var(--orange) 240deg,
        var(--danger) 240deg,
        var(--danger) 360deg
      );
    box-shadow: inset 0 -20px 40px rgba(0,0,0,0.6), 0 8px 30px rgba(3,8,20,0.6);
    position:relative;
    border: 6px solid rgba(255,255,255,0.02);
  }
  /* inner overlay limpio */
  .gauge-inner{
    width:70%;
    height:70%;
    border-radius:50%;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.45));
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    position:relative;
    box-shadow: inset 0 8px 20px rgba(0,0,0,0.6);
    z-index:3;
  }
  .temp-value{
    font-size:56px;
    font-weight:800;
    color:#fff;
    text-shadow:0 6px 20px rgba(0,0,0,0.6)
  }
  .temp-unit-center{
    font-size:18px;
    color:var(--muted);
    margin-top:4px;
  }
  .gauge-needle{
    --rot:0deg;
    position:absolute;
    width:8px;
    height:42%;
    background:linear-gradient(180deg,#fff,#ccecff);
    border-radius:6px;
    transform-origin:50% 90%;
    transform:translateY(-4%) rotate(var(--rot));
    box-shadow:0 8px 18px rgba(0,0,0,0.6);
    z-index:2;
  }
  .gauge-center-dot{
    position:absolute;
    width:26px;
    height:26px;
    border-radius:50%;
    background:#031017;
    border:4px solid rgba(255,255,255,0.06);
    z-index:4
  }
  .meta-center{
    font-size:14px;
    color:var(--muted);
    margin-top:8px;
    text-align:center;
  }

  /* right column */
  .right-col{display:flex;flex-direction:column;gap:12px}
  .status-card{
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px;
    border-radius:10px;
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.18));
    border:1px solid rgba(255,255,255,0.02)
  }
  .led{
    width:84px;
    height:84px;
    border-radius:14px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-size:20px;
    color:#042;
    box-shadow:0 8px 20px rgba(0,0,0,0.6)
  }
  .led.green{
    background:linear-gradient(180deg,var(--ok),#007a2b);
    color:#021
  }
  .led.red{
    background:linear-gradient(180deg,var(--danger),#a1002b);
    color:#250005
  }
  .led.yellow{
    background:linear-gradient(180deg,var(--yellow),#b37a00);
    color:#2b1a00
  }
  .led-label{font-size:13px;color:var(--muted)}
  .last-up{font-size:13px;color:var(--muted)}
  .banner{padding:10px;border-radius:8px;text-align:center;font-weight:700}
  .banner.reset{background:linear-gradient(90deg,#352e0b, #7a5d00);color:#fff}
  .banner.warn{background:linear-gradient(90deg,#311000,#6b0000);color:#fff}
  footer{font-size:12px;color:var(--muted);text-align:center;margin-top:10px}
  .small{font-size:13px;color:var(--muted)}
  .card-title{font-weight:700;margin-bottom:8px}
  .info-row{display:flex;gap:12px;align-items:center}
  .range-label{
    font-size:14px;
    color:var(--muted);
    padding:6px 10px;
    border-radius:8px;
    background:rgba(255,255,255,0.02)
  }
</style>
</head>
<body>
<header>
  <div class="logo-container">
    <!-- Logo de Millares -->
    <img src="logo-millares.png" alt="Logo Millares" class="logo-img">
    <div class="header-text">
      <h1>MONITOREO VARIABLES</h1>
      <div class="company-name">MILLARES BAGB SPA IOT CHILE</div>
      <div class="subtitle">Temperatura · Alarma · Reset — Pantalla para cliente</div>
    </div>
  </div>
</header>

<div class="container">
  <div class="main-grid">
    <div class="card">
      <div class="gauge-wrap">
        <div class="gauge-card">
          <div class="gauge" id="gauge">
            <div class="gauge-needle" id="needle" style="--rot:0deg"></div>
            <div class="gauge-inner">
              <div class="temp-value" id="temp-digital">--.-</div>
              <div class="temp-unit-center">°C</div>
            </div>
            <div class="gauge-center-dot"></div>
          </div>
        </div>

        <!-- Texto bajo el dial -->
        <div id="gauge-sub" class="meta-center">
          Última actualización: --
        </div>
        <div style="margin-top:10px;display:flex;flex-direction:column;align-items:center;gap:4px;">
          <div class="range-label">
            <b>RANGO IDEAL:</b> 20 y 30 °C
          </div>
          <div class="range-label" style="font-size:14px;">
            Actualización automática cada <b>30 s</b>
          </div>
        </div>
      </div>
    </div>

    <div class="right-col">
      <div class="card status-card">
        <div style="display:flex;flex-direction:column;align-items:center;gap:10px;width:100%">
          <div style="display:flex;gap:12px;width:100%;align-items:center;justify-content:space-between">
            <div style="display:flex;flex-direction:column">
              <div class="card-title">Estado alarma</div>
              <div id="alarma-text" class="small">No hay alarma</div>
            </div>
            <div id="led-alarma" class="led green">✓</div>
          </div>

          <div style="display:flex;gap:12px;width:100%;align-items:center;justify-content:space-between">
            <div style="display:flex;flex-direction:column">
              <div class="card-title">Reset</div>
              <div id="reset-text" class="small">No activo</div>
            </div>
            <div id="led-reset" class="led" style="background:rgba(255,255,255,0.02);color:var(--muted)">-</div>
          </div>

          <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-top:6px">
            <div class="last-up" id="last-up">Último ping: --</div>
            <div class="small" id="status-http">Conexión: --</div>
          </div>
        </div>
      </div>

      <div id="reset-banner" class="card banner reset" style="display:none">RESET ENVIADO</div>
      <div id="alarm-banner" class="card banner warn" style="display:none">ALARMA ACTIVADA</div>

      <div class="card">
        <div class="card-title">Información del sistema</div>
        <div class="small">
          Sistema de monitoreo IoT en tiempo real. Las actualizaciones se realizan automáticamente cada 30 segundos.
        </div>
      </div>
    </div>
  </div>
  
  <footer>
    &copy; 2024 MILLARES BAGB SPA IOT CHILE - Todos los derechos reservados
  </footer>
</div>

<script>
  // =============================================
  // CONFIGURACIÓN - REEMPLAZAR CON TUS CREDENCIALES
  // =============================================
  const CONFIG = {
    thingspeak: {
      channelId: '3194050',      // Ejemplo: '1234567'
      readApiKey: '4L6L63LNFO0YG4BB',  // Ejemplo: 'ABCDEFGHIJKLMNOP'
      field: 1,                         // Número del campo (1 para temperatura)
      url: 'https://api.thingspeak.com/channels/'
    },
    updateInterval: 30000, // 30 segundos
    alarmThreshold: 50,    // °C para activar alarma
    resetThreshold: 60     // °C para mostrar reset recomendado
  };

  // =============================================
  // FUNCIONES PRINCIPALES
  // =============================================
  
  // Función para obtener datos de ThingSpeak
  async function fetchThingSpeakData() {
    const { channelId, readApiKey, field, url } = CONFIG.thingspeak;
    const apiUrl = `${url}${channelId}/fields/${field}/last.json?api_key=${readApiKey}`;
    
    try {
      const response = await fetch(apiUrl);
      if (!response.ok) throw new Error('Error en la respuesta');
      
      const data = await response.json();
      return parseFloat(data[`field${field}`]) || 0;
    } catch (error) {
      console.error('Error fetching ThingSpeak:', error);
      // Simular datos si hay error (para prueba)
      return 20 + Math.random() * 40;
    }
  }

  // Función para actualizar la temperatura
  function updateGauge(temp) {
    const needle = document.getElementById('needle');
    const tempDigital = document.getElementById('temp-digital');
    
    // Actualizar valor digital
    tempDigital.textContent = temp.toFixed(1);
    
    // Calcular rotación de la aguja (0° = 0°C, 360° = 100°C)
    const rotation = Math.min(temp * 3.6, 360); // Máximo 360°
    needle.style.setProperty('--rot', `${rotation}deg`);
    
    // Cambiar color según temperatura
    if (temp >= 20 && temp <= 30) {
      tempDigital.style.color = '#00c853'; // Verde (ideal)
    } else if (temp > 30 && temp <= 50) {
      tempDigital.style.color = '#ffca28'; // Amarillo (precaución)
    } else if (temp > 50 && temp <= CONFIG.alarmThreshold) {
      tempDigital.style.color = '#ff9800'; // Naranja (alerta)
    } else if (temp > CONFIG.alarmThreshold) {
      tempDigital.style.color = '#ff1744'; // Rojo (peligro/alarma)
    } else {
      tempDigital.style.color = '#00bcd4'; // Azul (frío)
    }
    
    return temp;
  }

  // Función para actualizar estados de alarma y reset
  function updateStatus(temp) {
    const alarmLed = document.getElementById('led-alarma');
    const alarmText = document.getElementById('alarma-text');
    const resetLed = document.getElementById('led-reset');
    const resetText = document.getElementById('reset-text');
    const alarmBanner = document.getElementById('alarm-banner');
    const resetBanner = document.getElementById('reset-banner');
    
    // Estado de alarma
    if (temp > CONFIG.alarmThreshold) {
      alarmLed.className = 'led red';
      alarmLed.textContent = '!';
      alarmText.textContent = 'ALARMA ACTIVADA';
      alarmText.style.color = '#ff1744';
      alarmBanner.style.display = 'block';
    } else if (temp > 30) {
      alarmLed.className = 'led yellow';
      alarmLed.textContent = '⚠';
      alarmText.textContent = 'ADVERTENCIA';
      alarmText.style.color = '#ffca28';
      alarmBanner.style.display = 'none';
    } else {
      alarmLed.className = 'led green';
      alarmLed.textContent = '✓';
      alarmText.textContent = 'No hay alarma';
      alarmText.style.color = '';
      alarmBanner.style.display = 'none';
    }
    
    // Estado de reset
    if (temp > CONFIG.resetThreshold) {
      resetLed.className = 'led red';
      resetLed.textContent = '!';
      resetText.textContent = 'RESET RECOMENDADO';
      resetText.style.color = '#ff1744';
      resetBanner.style.display = 'block';
    } else {
      resetLed.className = 'led';
      resetLed.style.background = 'rgba(255,255,255,0.02)';
      resetLed.style.color = 'var(--muted)';
      resetLed.textContent = '-';
      resetText.textContent = 'No activo';
      resetText.style.color = '';
      resetBanner.style.display = 'none';
    }
  }

  // Función para actualizar timestamp y estado de conexión
  function updateTimestamp(success = true) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('es-CL', { 
      hour: '2-digit', 
      minute: '2-digit',
      second: '2-digit' 
    });
    const dateStr = now.toLocaleDateString('es-CL');
    
    document.getElementById('gauge-sub').textContent = `Última actualización: ${dateStr} ${timeStr}`;
    document.getElementById('last-up').textContent = `Último ping: ${timeStr}`;
    
    // Estado de conexión
    const statusEl = document.getElementById('status-http');
    if (success) {
      statusEl.textContent = 'Conexión: OK';
      statusEl.style.color = '#00c853';
    } else {
      statusEl.textContent = 'Conexión: ERROR';
      statusEl.style.color = '#ff1744';
    }
  }

  // Función principal de actualización
  async function updateDashboard() {
    try {
      const temperature = await fetchThingSpeakData();
      updateGauge(temperature);
      updateStatus(temperature);
      updateTimestamp(true);
    } catch (error) {
      console.error('Error en actualización:', error);
      updateTimestamp(false);
    }
  }

  // =============================================
  // INICIALIZACIÓN
  // =============================================
  document.addEventListener('DOMContentLoaded', function() {
    // Actualizar inmediatamente
    updateDashboard();
    
    // Actualizar cada 30 segundos
    setInterval(updateDashboard, CONFIG.updateInterval);
    
    // También actualizar el timestamp cada minuto (por si hay timeout)
    setInterval(() => updateTimestamp(true), 60000);
  });
</script>
</body>
</html>
